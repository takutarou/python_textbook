# 第7章：つまずきポイント集

## この章で学ぶこと
- 初心者が必ず遭遇する典型的な問題
- 環境関連のトラブルと解決方法
- パス、文字コード、その他のよくあるエラー

この章は「困った時に見る辞書」として使ってください。

---

## 7.1 環境関連でよくある問題

環境管理は初心者が最もつまずきやすいポイントです。

### 問題1：base環境で作業してしまう

#### 症状

```bash
(base) $ python script.py
ModuleNotFoundError: No module named 'pandas'
```

でも、インストールしたはずなのに...

#### 原因

- プロジェクト用の環境を作ったが、アクティベートしていない
- base環境で作業してしまっている

#### 確認方法

```bash
# 現在の環境を確認
conda env list
```

出力：
```
# conda environments:
#
base                  *  /Users/username/miniconda3
myproject                /Users/username/miniconda3/envs/myproject
```

`*` が base についている → base環境で作業している

#### 解決方法

```bash
# プロジェクトの環境をアクティベート
conda activate myproject

# プロンプトが変わることを確認
# (base) → (myproject)
```

#### 予防策

**プロジェクトを始める時の習慣：**
1. フォルダに移動
2. 環境をアクティベート
3. プロンプトを確認してから作業開始

```bash
cd ~/Documents/python_projects/myproject
conda activate myproject
# (myproject) と表示されることを確認してから作業
```

### 問題2：環境をアクティベートし忘れる

#### 症状

毎回 `conda activate` を実行するのを忘れて、base環境で作業してしまう。

#### VS Codeでの解決方法

VS Codeでインタープリタを正しく選択すれば、ターミナルを開いた時に自動でアクティベートされます。

**手順：**
1. VS Codeでプロジェクトフォルダを開く
2. 右下のPythonバージョン表示をクリック
3. プロジェクトの環境を選択（例：`myproject`）
4. 既存のターミナルを閉じる
5. 新しいターミナルを開く（`` Ctrl + ` ``）
6. 自動で `(myproject)` がアクティベートされる

**確認：**
```bash
# ターミナルを開いた直後のプロンプト
(myproject) PS C:\Users\username\Documents\python_projects\myproject>
```

### 問題3：VS Codeのインタープリタ（カーネル）選択を間違える

#### 症状

- VS Code右下に `Python 3.11.5 ('base': conda)` と表示されている
- 実際は `myproject` 環境を使いたい
- コードを実行すると、ライブラリが見つからないエラー

#### 原因

VS Codeが使用する環境を間違えている

#### 解決方法

**ステップ1：インタープリタ（カーネル）を変更**

**Jupyterノートブック（.ipynb）の場合：**
1. ノートブック右上の「カーネルを選択」または現在のカーネル名をクリック
2. 一覧から `Python 3.11.5 ('myproject': conda)` を選択
3. **重要：一度選択すれば、そのノートブックファイルには選択が保存される**
4. 次回ノートブックを開いた時も、同じカーネルが自動的に選択される

**Pythonスクリプト（.py）の場合：**
1. 右下の `Python 3.11.5 ('base': conda)` をクリック
2. 一覧から `Python 3.11.5 ('myproject': conda)` を選択

**ステップ2：ターミナルを再起動（.pyの場合のみ）**
1. 既存のターミナルを閉じる（ゴミ箱アイコン）
2. 新しいターミナルを開く
3. プロンプトが `(myproject)` になることを確認

#### Jupyterノートブックでのカーネル選択の特徴

**重要なポイント：**
- Jupyterノートブックは、**ファイルごとにカーネル選択が保存される**
- 一度正しいカーネルを選択すれば、次回開いた時も同じカーネルが使われる
- 基本的には、**プロジェクトの最初に一度だけ選択すればOK**
- 環境を変更したい場合だけ、再度カーネルを選び直す

**確認方法：**
- ノートブック右上に現在のカーネル名が表示される
- 例：`Python 3.11.5 (myproject)`

#### よくある混乱

```
# ターミナルのプロンプトは (myproject) だけど、
# VS Code右下は ('base': conda) のまま

→ これは不整合状態！
→ コードを実行すると、base環境で実行される
```

**解決：**
- Jupyterノートブック：カーネル選択を確認
- Pythonスクリプト：VS Code右下の表示とターミナルのプロンプトを一致させる

### 問題4：別の環境にライブラリをインストールしてしまった

#### 症状

```bash
# base環境でインストールしてしまった
(base) $ conda install pandas
# Successfully installed

# でもmyproject環境で実行するとエラー
(myproject) $ python script.py
ModuleNotFoundError: No module named 'pandas'
```

#### 原因

環境ごとにライブラリは独立している。base環境にインストールしても、myproject環境には入っていない。

#### 確認方法

```bash
# myproject環境に何がインストールされているか確認
conda activate myproject
conda list | grep pandas
# → 何も表示されない（インストールされていない）

# base環境を確認
conda activate base
conda list | grep pandas
# → pandas 2.0.3 と表示される（base環境にはある）
```

#### 解決方法

**正しい環境にインストールし直す：**
```bash
# 1. 正しい環境をアクティベート
conda activate myproject

# 2. プロンプトを確認
# (myproject) と表示されているか？

# 3. インストール
conda install pandas

# 4. 確認
conda list | grep pandas
```

#### 予防策

**ライブラリをインストールする前の確認習慣：**
```bash
# ステップ1：環境を確認
conda env list
# *がどこについているか確認

# ステップ2：プロンプトを確認
# (環境名) が正しいか確認

# ステップ3：インストール
conda install ライブラリ名
```

### 問題5：環境の切り替えがうまくいかない

#### 症状

```bash
$ conda activate myproject
# プロンプトが変わらない、または変な表示になる
```

#### 原因と解決方法（Windows）

**原因：** conda初期化ができていない

**解決方法：**
```bash
# Anaconda Promptで実行
conda init cmd.exe

# VS Codeを完全に閉じて再起動
```

---

## 7.2 パスの問題

ファイルの場所を指定する「パス」は、初心者がつまずきやすいポイントです。

### 基礎知識：パスとは

**パス（Path）** = ファイルやフォルダの場所を示す住所

```
C:\Users\username\Documents\python_projects\myproject\data.csv
                              ↑
                        これがパス（住所）
```

### 絶対パスと相対パス

#### 絶対パス（Absolute Path）

ルート（一番上）から完全に指定したパス。

**Windows：**
```
C:\Users\username\Documents\python_projects\myproject\data.csv
```

**特徴：**
- どこから実行しても同じ場所を指す
- 長くなりがち
- 他の人のPCでは動かない（パスが違うため）

#### 相対パス（Relative Path）

現在いる場所を基準にした相対的なパス。

**現在地：**
```
C:\Users\username\Documents\python_projects\myproject\
```

**ファイル構造：**
```
myproject/
  ├─ main.py          ← 今ここにいる
  ├─ data/
  │   └─ sales.csv
  └─ output/
      └─ result.txt
```

**相対パスの例：**
```python
# main.pyから見て
data = pd.read_csv("data/sales.csv")  # data/の中のsales.csv
```

**特徴：**
- 短く書ける
- プロジェクト全体を移動しても動く
- **推奨される方法**

### カレントディレクトリ（現在地）

**カレントディレクトリ** = 今いる場所

#### 確認方法

**コマンドで確認：**
```bash
cd
```

**Pythonコード内で確認：**
```python
import os
print(os.getcwd())
```

### 問題1：ファイルが見つからない（FileNotFoundError）

#### 症状

```python
data = pd.read_csv("sales.csv")
```

**エラー：**
```
FileNotFoundError: [Errno 2] No such file or directory: 'sales.csv'
```

#### 原因

1. ファイルが存在しない
2. ファイル名が間違っている
3. カレントディレクトリが違う

#### 解決手順

**ステップ1：ファイルの存在確認**

VS Codeのエクスプローラーで、ファイルが本当にあるか確認。

**ステップ2：ファイル名の確認**

```bash
dir
```

または、Pythonコードで確認：
```python
import os
print(os.listdir())
```

注意点：
- 大文字・小文字は区別される（`Sales.csv` と `sales.csv` は別物）
- スペースや特殊文字が入っていないか確認

**ステップ3：カレントディレクトリの確認**

```python
import os
print("現在地:", os.getcwd())
print("ファイル一覧:", os.listdir())
```

**ステップ4：パスを修正**

```python
# ファイル構造
# myproject/
#   ├─ scripts/
#   │   └─ main.py     ← 実行中のファイル
#   └─ data/
#       └─ sales.csv

# 間違い（salesはdata/の中にある）
data = pd.read_csv("sales.csv")

# 正しい（相対パスで指定）
data = pd.read_csv("../data/sales.csv")
# ../ = 一つ上のディレクトリ
```

### 問題2：相対パスの書き方が分からない

#### 基本ルール

| 記号 | 意味 | 例 |
|-----|------|---|
| `.` | 現在のディレクトリ | `./file.txt` |
| `..` | 一つ上のディレクトリ | `../file.txt` |
| `/` | ディレクトリの区切り | `data/file.csv` |

#### 実例

```
myproject/
  ├─ main.py          ← ここから
  ├─ data/
  │   ├─ sales.csv
  │   └─ products.csv
  ├─ output/
  │   └─ result.txt
  └─ scripts/
      └─ helper.py
```

**main.py から各ファイルへのパス：**
```python
# data/sales.csv
"data/sales.csv"

# data/products.csv
"data/products.csv"

# output/result.txt
"output/result.txt"

# scripts/helper.py
"scripts/helper.py"
```

**scripts/helper.py から各ファイルへのパス：**
```python
# main.py（一つ上に戻る）
"../main.py"

# data/sales.csv（一つ上に戻って、data/に入る）
"../data/sales.csv"

# output/result.txt
"../output/result.txt"
```

### 問題3：Windowsのバックスラッシュ問題

#### 症状

Windowsでパスをコピーすると：
```
C:\Users\username\Documents\data.csv
```

これをPythonで使うとエラーになることがある：
```python
data = pd.read_csv("C:\Users\username\Documents\data.csv")
# SyntaxError: (unicode error) 'unicodeescape' codec can't decode bytes
```

#### 原因

`\` がエスケープ文字として解釈されてしまう。
- `\U` → Unicodeエスケープと解釈される
- `\n` → 改行と解釈される

#### 解決方法

**方法1：スラッシュに変える（推奨）**
```python
data = pd.read_csv("C:/Users/username/Documents/data.csv")
# Windowsでも / が使える！
```

**方法2：rawストリング（r をつける）**
```python
data = pd.read_csv(r"C:\Users\username\Documents\data.csv")
# rをつけると、\がそのまま解釈される
```

**方法3：バックスラッシュを2つ重ねる**
```python
data = pd.read_csv("C:\\Users\\username\\Documents\\data.csv")
# \\ = 1つの\
```

**推奨：** 方法1（`/`を使う）が最もシンプル

---

## 7.3 日本語の扱い

日本語は文字コードの問題で、様々なトラブルの原因になります。

### 問題1：ファイル名に日本語を使ってエラー

#### 症状

```python
data = pd.read_csv("売上データ.csv")
# エラーが出る（環境による）
```

#### 原因

- Windowsの一部環境で日本語ファイル名が正しく処理されない
- パスに日本語が含まれると問題が起きやすい

#### 解決方法

**基本原則：ファイル名・フォルダ名に日本語を使わない**

```
❌ 売上データ.csv
❌ データ分析/
❌ 2024年1月.xlsx

✅ sales_data.csv
✅ data_analysis/
✅ 2024_01.xlsx
```

**既に日本語ファイル名がある場合：**
1. ファイル名を英数字に変更する
2. または、絶対パスで指定してencodingを明示

```python
data = pd.read_csv("売上データ.csv", encoding="utf-8")
# または
data = pd.read_csv("売上データ.csv", encoding="shift_jis")
```

### 問題2：CSVファイルを読み込むと文字化け

#### 症状

```python
data = pd.read_csv("sales.csv")
print(data)
```

**出力：**
```
   蜷榊燕    驥大峇
0  螟ｪ閾ｪ螟ｪ驥守伐ｯｧ    �ｽ雖�
```

日本語が文字化けしている！

#### 原因

CSVファイルの文字コードとPythonで指定した文字コードが違う。

**日本のExcelで作成したCSV：**
- 通常 `Shift-JIS` または `CP932` でエンコードされている

**Pythonのデフォルト：**
- `UTF-8` を想定している

#### 解決方法

**方法1：文字コードを指定する**

```python
# Shift-JISで読み込む
data = pd.read_csv("sales.csv", encoding="shift_jis")

# または
data = pd.read_csv("sales.csv", encoding="cp932")
```

**方法2：文字コードを自動判定する**

```python
import pandas as pd

# いくつかの文字コードを試す
encodings = ["utf-8", "shift_jis", "cp932", "euc-jp"]

for enc in encodings:
    try:
        data = pd.read_csv("sales.csv", encoding=enc)
        print(f"成功: {enc}")
        print(data.head())
        break
    except:
        print(f"失敗: {enc}")
```

**方法3：Excel保存時にUTF-8を指定（予防策）**

Excelで：
1. 「名前を付けて保存」
2. ファイルの種類：`CSV UTF-8（コンマ区切り）(*.csv)`
3. これで保存すれば、Pythonでそのまま読める

#### よく使う文字コード

| 文字コード | 説明 | 使用場面 |
|-----------|------|---------|
| `utf-8` | 国際標準、推奨 | 現代的なファイル |
| `shift_jis` | 日本の従来の標準 | 古いシステム |
| `cp932` | Windowsの日本語 | Excelで作成したCSV |
| `euc-jp` | Unix系の日本語 | 古いサーバーのファイル |

### 問題3：Pythonスクリプト内の日本語

#### コメントや文字列の日本語は基本的にOK

```python
# これは大丈夫
name = "山田太郎"
print(f"こんにちは、{name}さん")  # これもOK
```

**ただし条件：**
- ファイルがUTF-8で保存されている

#### VS Codeでの確認方法

右下のステータスバーに文字コードが表示される：
```
UTF-8    LF    Python
```

**UTF-8になっていない場合：**
1. 右下の文字コード表示をクリック
2. 「エンコード付きで保存」を選択
3. `UTF-8` を選択

### 問題4：print出力が文字化けする（Windows）

#### 症状

```python
print("こんにちは")
```

**出力：**
```
縺薙ｓ縺ｫ縺｡縺ｯ
```

#### 原因（Windowsのコマンドプロンプト）

コマンドプロンプトの文字コードが `Shift-JIS` になっている。

#### 解決方法

**一時的な解決（その場しのぎ）：**
```bash
# コマンドプロンプトで実行
chcp 65001
# 65001 = UTF-8
```

**根本的な解決：**

VS Codeのターミナルを使う（通常は問題ない）

または、Pythonスクリプトの先頭に：
```python
import sys
import io

sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
```

---

## 7.4 その他のよくあるエラー

### エラー1：ModuleNotFoundError

**エラーメッセージ：**
```
ModuleNotFoundError: No module named 'pandas'
```

#### チェックリスト

1. ライブラリはインストールしたか？
   ```bash
   conda list | grep pandas
   ```

2. 正しい環境でインストールしたか？
   ```bash
   # 現在の環境を確認
   conda env list
   # * がどこについているか
   ```

3. 正しい環境をアクティベートしたか？
   ```bash
   conda activate 環境名
   ```

4. VS Codeのインタープリタは正しいか？
   - 右下のPython表示を確認

### エラー2：SyntaxError（文法エラー）

**エラーメッセージ：**
```
SyntaxError: invalid syntax
```

#### よくある原因

**原因1：括弧の閉じ忘れ**
```python
# 間違い
print("Hello"

# 正しい
print("Hello")
```

**原因2：コロンの忘れ**
```python
# 間違い
if x > 0
    print("positive")

# 正しい
if x > 0:
    print("positive")
```

**原因3：クォートの不一致**
```python
# 間違い
name = "太郎'

# 正しい
name = "太郎"
```

**原因4：全角文字の混入**
```python
# 間違い（全角スペース）
if x > 0：  # このコロンが全角
    print("positive")

# 正しい
if x > 0:  # 半角コロン
    print("positive")
```

#### デバッグ方法

エラーの `^` マークが指す場所を確認：
```python
  File "main.py", line 5
    print("Hello"
                 ^
SyntaxError: invalid syntax
```

`^` の位置またはその直前に問題がある。

### エラー3：IndentationError（インデントエラー）

**エラーメッセージ：**
```
IndentationError: unexpected indent
```

#### 原因

Pythonはインデント（字下げ）で構造を表現するため、インデントが不適切だとエラーになる。

**間違い：**
```python
def calculate():
    x = 10
        y = 20  # インデントが深すぎる
    return x + y
```

**正しい：**
```python
def calculate():
    x = 10
    y = 20  # 揃える
    return x + y
```

#### タブとスペースの混在

```python
def calculate():
    x = 10      # スペース4つ
	y = 20      # タブ（見た目は同じでもエラー）
    return x + y
```

**解決方法：**

VS Codeの設定：
1. 設定を開く（`Ctrl + ,`）
2. `indent` で検索
3. 「Tab Size」を `4` に設定
4. 「Insert Spaces」をオンにする

これで、Tabキーを押してもスペース4つが挿入される。

### エラー4：NameError

**エラーメッセージ：**
```
NameError: name 'x' is not defined
```

#### 原因

変数やライブラリを使う前に定義していない。

**間違い：**
```python
print(x)  # xがまだ定義されていない
x = 10
```

**正しい：**
```python
x = 10
print(x)
```

**ライブラリの場合：**
```python
# 間違い
data = pd.read_csv("data.csv")  # pdがimportされていない

# 正しい
import pandas as pd
data = pd.read_csv("data.csv")
```

### エラー5：KeyError（辞書・DataFrameのキーエラー）

**エラーメッセージ：**
```
KeyError: 'amount'
```

#### 原因（DataFrame）

指定した列名が存在しない。

```python
import pandas as pd

data = pd.read_csv("sales.csv")
total = data["amount"].sum()  # 'amount'列が存在しない
```

#### デバッグ方法

**列名を確認：**
```python
print(data.columns)
# Index(['date', 'product', 'price'], dtype='object')
# 'amount'はない！'price'が正しい
```

**よくある原因：**
- タイプミス：`amount` vs `Amount`（大文字・小文字）
- スペース：`amount` vs `amount `（後ろにスペース）
- 列名の勘違い

**解決：**
```python
# 正しい列名を使う
total = data["price"].sum()
```

### エラー6：TypeError（型エラー）

**エラーメッセージ：**
```
TypeError: can only concatenate str (not "int") to str
```

#### 原因

異なる型を混ぜて計算しようとした。

**間違い：**
```python
name = "太郎"
age = 25
print("名前: " + name + ", 年齢: " + age)
# 文字列 + 整数はできない
```

**正しい：**
```python
# 方法1：文字列に変換
print("名前: " + name + ", 年齢: " + str(age))

# 方法2：f-string（推奨）
print(f"名前: {name}, 年齢: {age}")
```

---

## トラブルシューティングのフローチャート

```
エラーが出た！
    ↓
エラーメッセージを読む
    ↓
エラーの種類を確認
    ↓
┌─────────────────────────────────┐
│ ModuleNotFoundError             │
│ → 7.4の対処法へ                   │
├─────────────────────────────────┤
│ FileNotFoundError               │
│ → 7.2のパス問題へ                 │
├─────────────────────────────────┤
│ 文字化け                         │
│ → 7.3の日本語問題へ               │
├─────────────────────────────────┤
│ SyntaxError / IndentationError  │
│ → 7.4の文法エラーへ               │
├─────────────────────────────────┤
│ その他                           │
│ → Google検索                     │
│ → 公式ドキュメント                 │
│ → 社内で質問                      │
└─────────────────────────────────┘
```

---

## エラー解決のための心構え

### 1. エラーは敵ではない

- エラーは「ここが間違っているよ」と教えてくれている
- エラーメッセージは友達

### 2. 焦らず、メッセージを読む

- エラーメッセージには解決のヒントがある
- 最後の1行（エラーの種類）をまず見る
- ファイル名と行番号を確認

### 3. 一つずつ確認

```
□ ファイル名は正しいか？
□ 環境はアクティベートされているか？
□ ライブラリはインストールされているか？
□ パスは正しいか？
□ 文字コードは正しいか？
```

### 4. 最小のコードで試す

複雑なコードでエラーが出たら、最小限のコードで動作確認：

```python
# 最小のテスト
import pandas as pd
print("pandasが読み込めた")

data = pd.read_csv("data.csv")
print("ファイルが読み込めた")
```

### 5. Google検索を活用

**検索のコツ：**
```
# エラーメッセージをそのまま検索
"ModuleNotFoundError: No module named 'pandas'"

# 言語を指定
python pandas ModuleNotFoundError

# 日本語で検索
python pandas モジュールが見つからない
```

---

## まとめ

この章では、初心者が必ずつまずくポイントを解説しました：

- ✅ 環境管理の問題（base環境、アクティベート忘れ）
- ✅ パスの問題（相対パス、Windows の \）
- ✅ 日本語の問題（ファイル名、文字コード）
- ✅ よくあるエラー（ModuleNotFoundError、SyntaxError等）

**重要なポイント：**
1. プロンプトを常に確認（どの環境で作業しているか）
2. パスは相対パスを使う
3. ファイル名・フォルダ名に日本語を使わない
4. エラーメッセージをよく読む
5. 焦らず一つずつ確認

**この章は辞書として使ってください：**
- エラーが出たら、該当する節を読み返す
- 同じエラーに何度も遭遇するのは普通
- 徐々に慣れていきます

次の章では、情報収集の方法と質問のコツを学びます。

---

## 確認問題

1. `(base)` 環境で作業してしまう問題を防ぐには、どうすればよいですか？
2. VS Codeで環境を自動アクティベートするには、何を設定すればよいですか？
3. 相対パスで「一つ上のディレクトリ」を表す記号は何ですか？
4. Windowsでパスに `\` を使うと問題が起きます。代わりに何を使えばよいですか？
5. Excelで作成したCSVを読み込むと文字化けします。最初に試すべき対処法は？
6. `ModuleNotFoundError` が出た時、最初に確認すべきことは何ですか？

---

**前の章へ：** [第6章：実践的な開発の流れ](./第6章_実践的な開発の流れ.md)
**次の章へ：** [第8章：情報収集とヘルプ](./第8章_情報収集とヘルプ.md)
