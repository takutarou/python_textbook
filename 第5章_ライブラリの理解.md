# 第5章：ライブラリの理解

## この章で学ぶこと
- ライブラリとは何か、なぜ必要なのか
- **「インストール」と「インポート」の決定的な違い**（最重要）
- conda環境でのライブラリ管理方法
- 実際にライブラリを使ってみる

**この章は初心者が最もつまずきやすいポイントです。じっくり読んで理解しましょう！**

---

## 5.1 ライブラリとは何か

### ライブラリの概念

**ライブラリ**とは、よく使う機能をまとめた「部品集」「道具箱」のようなものです。

#### 例え話：料理に置き換えると

**ライブラリなしの場合：**
- カレーを作りたい
- 小麦粉からルーを作る
- スパイスを調合する
- すべて一から作る → 大変！

**ライブラリありの場合：**
- カレーを作りたい
- 市販のカレールーを使う（これがライブラリ）
- 簡単に美味しいカレーができる

Pythonのライブラリも同じです：
- 複雑な処理を誰かが作ってくれている
- それを使えば、簡単に高度なことができる

### 標準ライブラリと外部ライブラリ

Pythonには2種類のライブラリがあります。

#### 標準ライブラリ

Pythonをインストールすると**最初から入っている**ライブラリ。

**例：**
```python
import math        # 数学関数
import datetime    # 日付・時刻処理
import os          # ファイル・ディレクトリ操作
import random      # 乱数生成
import json        # JSON形式データの処理
```

**特徴：**
- インストール不要
- `import` するだけで使える
- 基本的な機能が揃っている

**使用例：**
```python
import math

# 円周率を使う
print(math.pi)  # 3.141592653589793

# 平方根を計算
print(math.sqrt(16))  # 4.0
```

#### 外部ライブラリ（サードパーティライブラリ）

Python本体には含まれておらず、**別途インストールが必要**なライブラリ。

**よく使う外部ライブラリ：**

| ライブラリ名 | 用途 | 説明 |
|------------|------|------|
| **pandas** | データ分析 | 表形式データの操作、CSV/Excel読み込み |
| **numpy** | 数値計算 | 高速な配列演算、科学技術計算 |
| **matplotlib** | グラフ作成 | データの可視化、グラフ描画 |
| **requests** | Web通信 | Webページの取得、API利用 |
| **openpyxl** | Excel操作 | Excelファイルの読み書き |
| **beautifulsoup4** | Web解析 | Webページから情報を抽出 |

### なぜライブラリを使うのか

#### 理由1：開発時間の短縮

**ライブラリなし：**
```python
# CSVファイルを読み込んで、列の合計を計算する
# → 100行以上のコードが必要
```

**ライブラリあり（pandas）：**
```python
import pandas as pd

data = pd.read_csv("data.csv")
total = data["amount"].sum()
print(total)
# → たった3行！
```

#### 理由2：高品質・高性能

- 専門家が作っているので、バグが少ない
- 最適化されていて、処理が速い
- 多くの人が使っていて、信頼性が高い

#### 理由3：標準化

- 多くの人が同じライブラリを使う
- コードを共有しやすい
- 学習リソース（チュートリアル、質問サイト）が豊富

---

## 5.2 インストールとインポートの決定的な違い

**この節は最も重要です！** 初心者の9割がここでつまずきます。

### 2つの異なる作業

外部ライブラリを使うには、**2つの異なる作業**が必要です：

1. **インストール（conda install）** → PCに部品をダウンロードする
2. **インポート（import）** → スクリプト内で部品を使えるようにする

### インストール（conda install）とは

#### 概念

**PCに部品をダウンロードして、保管庫に入れる作業**

- 一度だけ実行すれば良い
- conda環境ごとに実行が必要
- ターミナルで実行するコマンド

#### 実行場所

**ターミナル（コマンドライン）で実行**

```bash
conda install pandas
```

#### いつ実行するか

- プロジェクトを始める時、最初の一度だけ
- 新しいライブラリを使いたくなった時
- 環境を新しく作った時

#### 例え話：工具箱

家に工具箱を買ってくる作業 → **インストール**
- 一度買えば、家に置いておける
- 使う度に買いに行く必要はない

### インポート（import）とは

#### 概念

**スクリプト実行時に、保管庫から部品を取り出して使えるようにする宣言**

- スクリプトを実行する度に必要
- Pythonコード内に書く
- ファイルごとに書く必要がある

#### 実行場所

**Pythonスクリプト（.pyファイル）の中に書く**

```python
import pandas
```

#### いつ実行するか

- スクリプトの最初（通常はファイルの先頭）
- そのファイルでライブラリを使う時は毎回必要

#### 例え話：工具箱の続き

工具箱から工具を取り出して作業する → **インポート**
- 作業する度に、工具箱から取り出す
- 取り出さないと使えない

### 図解で理解する

```
【インストール】ターミナルで一度だけ実行
━━━━━━━━━━━━━━━━━━━━━━━━━━
$ conda install pandas
━━━━━━━━━━━━━━━━━━━━━━━━━━
         ↓ ダウンロード
    ┌─────────────┐
    │ PCの保管庫   │
    │ (conda環境)  │
    ├─────────────┤
    │ pandas       │ ← インストール完了
    │ numpy        │
    │ matplotlib   │
    └─────────────┘


【インポート】スクリプトの中で毎回書く
━━━━━━━━━━━━━━━━━━━━━━━━━━
# script.py
import pandas
━━━━━━━━━━━━━━━━━━━━━━━━━━
         ↓ 取り出す
    ┌─────────────┐
    │ 実行中の     │
    │ スクリプト   │
    ├─────────────┤
    │ pandas を    │ ← 使える状態
    │ 使える       │
    └─────────────┘
```

### よくある誤解とエラー

#### パターン1：インストールしたのにエラーが出る

**状況：**
```bash
# ターミナルでインストール済み
$ conda install pandas
# Successfully installed
```

**スクリプト：**
```python
# script.py
data = pandas.read_csv("data.csv")  # importを忘れている
```

**実行結果：**
```
NameError: name 'pandas' is not defined
```

**原因：**
- インストールはした
- でも、スクリプトで `import` していない

**正しい方法：**
```python
# script.py
import pandas as pd  # ← これが必要！

data = pd.read_csv("data.csv")
```

#### パターン2：importしたのにエラーが出る

**スクリプト：**
```python
# script.py
import pandas as pd  # インストールしていないのにimport

data = pd.read_csv("data.csv")
```

**実行結果：**
```
ModuleNotFoundError: No module named 'pandas'
```

**原因：**
- `import` は書いた
- でも、事前にインストールしていない

**正しい手順：**
```bash
# 1. まずターミナルでインストール
conda install pandas

# 2. それからスクリプトでimport
```

```python
# script.py
import pandas as pd  # これでOK
```

#### パターン3：別の環境にインストールしてしまった

**状況：**
```bash
# base環境でインストールしてしまった
(base) $ conda install pandas

# でも、プロジェクトはproject_a環境で動かす
(project_a) $ python script.py
ModuleNotFoundError: No module named 'pandas'
```

**原因：**
- 環境が違う
- base環境にはインストールされている
- でもproject_a環境にはインストールされていない

**正しい手順：**
```bash
# 正しい環境をアクティベート
conda activate project_a

# その環境にインストール
(project_a) $ conda install pandas

# 確認
(project_a) $ conda list | grep pandas
```

### まとめ：2つの違い

| 項目 | インストール（conda install） | インポート（import） |
|------|---------------------------|-------------------|
| **実行場所** | ターミナル | Pythonスクリプト内 |
| **実行回数** | 環境ごとに一度だけ | スクリプトを実行する度 |
| **目的** | ライブラリをPCにダウンロード | ライブラリをスクリプトで使えるようにする |
| **書き方** | `conda install pandas` | `import pandas` |
| **エラー例** | ネットワークエラー、パッケージが見つからない | `ModuleNotFoundError`, `NameError` |

**覚え方：**
- **インストール** = 買い物（一度だけ）
- **インポート** = 使う宣言（毎回）

---

## 5.3 conda環境でのライブラリ管理

### conda installの基本

#### 基本構文

```bash
conda install ライブラリ名
```

#### 実行例

```bash
# pandasをインストール
conda install pandas

# 複数のライブラリを一度にインストール
conda install pandas numpy matplotlib

# 特定のバージョンを指定
conda install pandas=2.0.0
```

#### インストールの流れ

```bash
$ conda install pandas
```

実行すると：

```
Collecting package metadata (current_repodata.json): done
Solving environment: done

## Package Plan ##

  environment location: /Users/username/miniconda3/envs/project

  added / updated specs:
    - pandas


The following packages will be downloaded:

    package                    |            build
    ---------------------------|-----------------
    pandas-2.0.3               |   py311h1234567_0         12.5 MB
    ...

The following NEW packages will be INSTALLED:

  pandas             pkgs/main/osx-64::pandas-2.0.3-py311h1234567_0
  numpy              pkgs/main/osx-64::numpy-1.24.3-py311h1234567_0
  ...

Proceed ([y]/n)?
```

**`y` を入力してEnter**

```
Downloading and Extracting Packages
pandas-2.0.3         | 12.5 MB   | ##################################### | 100%
...

Preparing transaction: done
Verifying transaction: done
Executing transaction: done
```

**インストール完了！**

### インストールされたライブラリの確認

#### 方法1：conda list

```bash
conda list
```

現在の環境にインストールされているすべてのパッケージが表示されます：

```
# packages in environment at /Users/username/miniconda3/envs/project:
#
# Name                    Version                   Build  Channel
numpy                     1.24.3          py311h1234567_0
pandas                    2.0.3           py311h1234567_0
python                    3.11.5               h1234567_0
...
```

#### 方法2：特定のライブラリを検索

```bash
# Windowsの場合
conda list | findstr pandas

# Macの場合
conda list | grep pandas
```

出力：
```
pandas                    2.0.3           py311h1234567_0
```

### conda-forgeチャンネルの説明

#### チャンネルとは

condaがパッケージをダウンロードする「配信元」のこと。

**主なチャンネル：**
1. **defaults**（デフォルト）
   - Anaconda社が提供
   - 安定性重視

2. **conda-forge**
   - コミュニティが提供
   - パッケージの種類が豊富
   - 最新バージョンが早く提供される

#### conda-forgeを使う理由

- defaultsチャンネルにないパッケージがある
- より新しいバージョンが欲しい時

#### 使い方

```bash
# conda-forgeからインストール
conda install -c conda-forge ライブラリ名

# 例
conda install -c conda-forge openpyxl
```

**`-c` オプション：channel（チャンネル）の指定**

#### conda-forgeを優先する設定（オプション）

```bash
# conda-forgeを優先チャンネルに設定
conda config --add channels conda-forge
conda config --set channel_priority strict
```

これ以降、`conda install` で自動的にconda-forgeから検索されます。

### ライブラリのアンインストール

不要になったライブラリを削除する：

```bash
conda uninstall ライブラリ名

# 例
conda uninstall pandas
```

確認メッセージが出るので、`y` を入力。

### ライブラリのアップデート

```bash
# 特定のライブラリを更新
conda update pandas

# すべてのライブラリを更新（注意が必要）
conda update --all
```

**注意：**
- `conda update --all` は依存関係が壊れる可能性がある
- 本番環境では慎重に

### environment.ymlでの環境共有（発展）

#### 環境を記録する

現在の環境の内容をファイルに保存：

```bash
conda env export > environment.yml
```

**`environment.yml` の中身：**
```yaml
name: project
channels:
  - defaults
dependencies:
  - python=3.11.5
  - pandas=2.0.3
  - numpy=1.24.3
  - matplotlib=3.7.2
```

#### 環境を再現する

チームメンバーや別のPCで、同じ環境を作る：

```bash
conda env create -f environment.yml
```

これで、全く同じライブラリ構成の環境が作られます。

**メリット：**
- チーム開発で環境を統一できる
- 「私のPCでは動くのに...」を防げる
- 本番環境と開発環境を揃えられる

---

## 5.4 実践：ライブラリを使ってみる

実際にライブラリをインストールして使ってみましょう。

### 実践1：pandasでCSVファイルを読み込む

#### ステップ1：環境をアクティベート

```bash
conda activate data_analysis
```

#### ステップ2：pandasをインストール

```bash
conda install pandas
```

`y` を入力してインストール完了を待つ。

#### ステップ3：サンプルCSVファイルを作成

VS Codeで新しいファイル `sales.csv` を作成：

```csv
date,product,amount
2024-01-01,Apple,1000
2024-01-02,Banana,500
2024-01-03,Orange,800
2024-01-04,Apple,1200
2024-01-05,Banana,600
```

#### ステップ4：Pythonスクリプトを作成

新しいファイル `read_csv.py` を作成：

```python
# CSVファイルを読み込んで分析する

# pandasをインポート
import pandas as pd

# CSVファイルを読み込む
data = pd.read_csv("sales.csv")

# データの内容を表示
print("=== データの内容 ===")
print(data)

# 合計金額を計算
total = data["amount"].sum()
print(f"\n合計売上: {total}円")

# 商品ごとの売上を集計
product_total = data.groupby("product")["amount"].sum()
print("\n=== 商品別売上 ===")
print(product_total)
```

#### ステップ5：実行

```bash
python read_csv.py
```

**出力：**
```
=== データの内容 ===
         date product  amount
0  2024-01-01   Apple    1000
1  2024-01-02  Banana     500
2  2024-01-03  Orange     800
3  2024-01-04   Apple    1200
4  2024-01-05  Banana     600

合計売上: 4100円

=== 商品別売上 ===
product
Apple     2200
Banana    1100
Orange     800
Name: amount, dtype: int64
```

**すごい！たった数行で高度なデータ分析ができました！**

### 実践2：matplotlibでグラフを作成する

#### ステップ1：matplotlibをインストール

```bash
conda install matplotlib
```

#### ステップ2：グラフ作成スクリプト

新しいファイル `create_graph.py` を作成：

```python
# グラフを作成する

import pandas as pd
import matplotlib.pyplot as plt

# CSVファイルを読み込む
data = pd.read_csv("sales.csv")

# 商品ごとの売上を集計
product_total = data.groupby("product")["amount"].sum()

# 棒グラフを作成
plt.figure(figsize=(8, 6))
product_total.plot(kind="bar")
plt.title("Product Sales")
plt.xlabel("Product")
plt.ylabel("Amount (Yen)")
plt.xticks(rotation=0)

# グラフを保存
plt.savefig("sales_graph.png")
print("グラフを sales_graph.png に保存しました")

# グラフを表示
plt.show()
```

#### ステップ3：実行

```bash
python create_graph.py
```

- `sales_graph.png` が生成される
- グラフのウィンドウが表示される（環境によって異なる）

**わずか10数行で、データを読み込んでグラフまで作成できました！**

### importの書き方バリエーション

#### 基本形

```python
import pandas
```

使用時：
```python
data = pandas.read_csv("data.csv")
```

#### as で別名をつける（推奨）

```python
import pandas as pd
```

使用時：
```python
data = pd.read_csv("data.csv")  # 短く書ける
```

**慣習的な別名：**
- `pandas` → `pd`
- `numpy` → `np`
- `matplotlib.pyplot` → `plt`

#### 特定の機能だけインポート

```python
from pandas import read_csv
```

使用時：
```python
data = read_csv("data.csv")  # pandas.なしで使える
```

#### 複数の機能をインポート

```python
from pandas import read_csv, DataFrame
```

#### すべてインポート（非推奨）

```python
from pandas import *
```

**なぜ非推奨？**
- どの関数がどのライブラリから来たか分からなくなる
- 名前の衝突が起きやすい

**推奨される書き方：**
```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
```

---

## よくあるエラーと対処法（ライブラリ編）

### エラー1：ModuleNotFoundError

**エラーメッセージ：**
```
ModuleNotFoundError: No module named 'pandas'
```

**原因：**
1. ライブラリがインストールされていない
2. 違う環境にインストールしている

**対処法：**

```bash
# 1. 正しい環境がアクティベートされているか確認
conda env list

# 2. 正しい環境をアクティベート
conda activate 環境名

# 3. その環境にインストールされているか確認
conda list | grep pandas

# 4. なければインストール
conda install pandas
```

### エラー2：ImportError

**エラーメッセージ：**
```
ImportError: cannot import name 'DataFrame' from 'pandas'
```

**原因：**
- バージョンが古い
- インストールが不完全

**対処法：**
```bash
# アップデート
conda update pandas

# それでもダメなら再インストール
conda uninstall pandas
conda install pandas
```

### エラー3：NameError（importし忘れ）

**エラーメッセージ：**
```
NameError: name 'pd' is not defined
```

**原因：**
`import` 文を書き忘れている

**対処法：**
スクリプトの先頭に追加：
```python
import pandas as pd
```

### エラー4：AttributeError

**エラーメッセージ：**
```
AttributeError: module 'pandas' has no attribute 'read_csv'
```

**原因：**
- タイプミス
- 自分で作ったファイル名がライブラリ名と衝突している

**よくある間違い：**
```
プロジェクトフォルダ/
  ├─ pandas.py  ← これがダメ！ライブラリと同じ名前
  └─ script.py
```

**対処法：**
- ファイル名を `pandas.py` 以外にする（例：`my_script.py`）
- `pandas.pyc` があれば削除する

---

## まとめ

この章では、ライブラリの使い方を学びました：

- ✅ ライブラリは「部品集」
- ✅ 標準ライブラリと外部ライブラリの違い
- ✅ **インストール（conda install）= PCにダウンロード（一度だけ）**
- ✅ **インポート（import）= スクリプトで使う宣言（毎回）**
- ✅ この2つは全く別の作業
- ✅ conda環境ごとにインストールが必要
- ✅ 環境をアクティベートしてからインストール
- ✅ pandasでCSV読み込み、matplotlibでグラフ作成

**最重要ポイント：**

```
ターミナルで一度：conda install pandas
    ↓
スクリプトで毎回：import pandas as pd
```

この違いを理解すれば、ライブラリ関連のエラーの8割は解決できます！

次の章では、実践的な開発の流れを学びます。

---

## 確認問題

1. 標準ライブラリと外部ライブラリの違いは何ですか？
2. `conda install pandas` と `import pandas` の違いを説明してください
3. それぞれどこで実行しますか？（ターミナル/スクリプト内）
4. 環境を変えたら、ライブラリをインストールし直す必要がありますか？
5. `import pandas as pd` の `as pd` は何のためにありますか？
6. `ModuleNotFoundError` が出た時、最初に確認すべきことは何ですか？

---

**前の章へ：** [第4章：初めてのPythonスクリプト](./第4章_初めてのPythonスクリプト.md)
**次の章へ：** [第6章：実践的な開発の流れ](./第6章_実践的な開発の流れ.md)
